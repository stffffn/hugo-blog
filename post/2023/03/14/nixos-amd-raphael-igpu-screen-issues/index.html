<!doctype html><html lang=en-US><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><link rel=alternate type=application/rss+xml title="RSS Feed for blabli.blog" href=https://blabli.blog/index.xml><meta property="og:title" content="NixOS + AMD Raphael iGPU: Fix for white/flashing Screens and a Guide for Graphical Installation / Bla Bli Blog"><meta property="og:description" content="
    
      How to fix white or flashing screens in NixOS when using the iGPU of an AMD Ryzen 7000 series CPU (Raphael).
    
  "><meta property="og:type" content="
    article
  "><meta property="og:url" content="https://blabli.blog/post/2023/03/14/nixos-amd-raphael-igpu-screen-issues/"><meta property="og:image" content="https://blabli.blog/images/nixos-amd/nixos-amd-feature-image.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-03-14T00:00:00+00:00"><meta property="article:modified_time" content="2023-03-14T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blabli.blog/images/nixos-amd/nixos-amd-feature-image.png"><meta name=twitter:title content="NixOS + AMD Raphael iGPU: Fix for white/flashing Screens and a Guide for Graphical Installation / Bla Bli Blog"><meta name=twitter:description content="
    
      How to fix white or flashing screens in NixOS when using the iGPU of an AMD Ryzen 7000 series CPU (Raphael).
    
  "><title>NixOS + AMD Raphael iGPU: Fix for white/flashing Screens and a Guide for Graphical Installation / Bla Bli Blog</title><meta name=author content="stffffn"><meta name=description content="
        
          How to fix white or flashing screens in NixOS when using the iGPU of an AMD Ryzen 7000 series CPU (Raphael).
        

      
      "><link key=canonical rel=canonical href=https://blabli.blog/post/2023/03/14/nixos-amd-raphael-igpu-screen-issues/><link rel=icon type=image/png sizes=32x32 href=https://blabli.blog/favicons/favicon-32.png><link rel=icon type=image/png sizes=128x128 href=https://blabli.blog/favicons/favicon-128.png><link rel=icon type=image/png sizes=192x192 href=https://blabli.blog/favicons/favicon-192.png><link rel=apple-touch-icon type=image/png sizes=152x152 href=https://blabli.blog/favicons/favicon-152.png><link rel=apple-touch-icon type=image/png sizes=167x167 href=https://blabli.blog/favicons/favicon-167.png><link rel=apple-touch-icon type=image/png sizes=180x180 href=https://blabli.blog/favicons/favicon-180.png><link rel="shortcut icon" type=image/png sizes=196x196 href=https://blabli.blog/favicons/favicon-196.png><link rel=stylesheet href=https://blabli.blog/scss/styles.css><link href=https://blabli.blog/fontawesome/css/fontawesome.min.css rel=stylesheet><link href=https://blabli.blog/fontawesome/css/brands.min.css rel=stylesheet><link href=https://blabli.blog/fontawesome/css/solid.min.css rel=stylesheet></head><body><header><a aria-label=Home title="Bla Bli Blog" href=https://blabli.blog>Bla Bli Blog</a><nav><a class=menu-item aria-label=Tags title=Tags href=https://blabli.blog/tags/><i class="fa-solid fa-hashtag"></i></a>
<a class=menu-item aria-label=RSS title=RSS href=https://blabli.blog/index.xml><i class="fa-solid fa-square-rss"></i></a>
<a class=menu-item target=_blank rel="noopener noreferrer" aria-label=GitHub title=GitHub href=https://github.com/stffffn><i class="fa-brands fa-github"></i></a>
<a class=menu-item target=_blank rel="noopener noreferrerme" aria-label=Mastodon title=Mastodon href=https://mastodon.social/@stffffn><i class="fa-brands fa-mastodon"></i></a></nav></header><main><article><div class=post-info><h2>NixOS + AMD Raphael iGPU: Fix for white/flashing Screens and a Guide for Graphical Installation</h2><div class=post-data><time datetime=2023-03-14>March 14, 2023</time><div class=post-tags><a aria-label=#amd title=#amd href=https://blabli.blog/tags/amd>#amd</a>
<a aria-label=#linux title=#linux href=https://blabli.blog/tags/linux>#linux</a>
<a aria-label=#nixos title=#nixos href=https://blabli.blog/tags/nixos>#nixos</a></div></div></div><div class=post-content><div class="alert alert-update"><h3>Update</h3><p>The fix is now also available as a module in <a target=_blank rel="noopener noreferrer" href=https://github.com/NixOS/nixos-hardware/blob/master/common/cpu/amd/raphael/igpu.nix>nixos-hardware</a></p></div><p>This post has a tl;dr section just for the necessary changes to get the integrated GPU (iGPU) working and fix the screen issues, a short write-up of my experience, with some additional links for further information and at the end you&rsquo;ll find a condensed guide for the graphical installation process.</p><h2 id=tldr><a href=#tldr>tl;dr</a></h2><p>To be able to use the integrated graphics of your Ryzen 7000-series CPU you can either&mldr;</p><ul><li>use the 6.1 kernel:</li></ul><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#c1abea>boot</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>kernelPackages</span> = <span style=color:#c1abea>pkgs</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>linuxPackages_6_1</span>;
</span></span></code></pre></div><ul><li>or use the latest kernel, which also needs an additional kernel parameter to fix the white or flashing screen issues:</li></ul><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#c1abea>boot</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>kernelPackages</span> = <span style=color:#c1abea>pkgs</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>linuxPackages_latest</span>;
</span></span><span style=display:flex><span><span style=color:#c1abea>boot</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>kernelParams</span> = [<span style=color:#63c381>&#34;amdgpu.sg_display=0&#34;</span>];
</span></span></code></pre></div><p>Well, at least both solutions worked for me.<br>Tested with LightDM + XFCE, SDDM + KDE Plasma, GDM + GNOME.</p><h2 id=my-experience><a href=#my-experience>My experience</a></h2><p>A week ago I built a new desktop PC including an AMD Ryzen 7950x. For the time being I use its iGPU to run my 32" 4k monitor (LG 32BN67U-B) via HDMI.</p><p>At the time of writing this post, the current NixOS version is 22.11, which comes with the 5.15 Linux kernel. Support for the iGPU of the new AMD Ryzen 7000 series CPUs (Raphael) comes with a later version of the kernel (5.18). Therefore, the issues aren&rsquo;t specific to NixOS, but affect any Linux distribution that comes with a kernel that is too old.</p><p>To use the latest kernel (6.2) in NixOS I added <code>boot.kernelPackages = pkgs.linuxPackages_latest</code> to the <code>configuration.nix</code> file.</p><p>Without any changes I booted straight to tty after the installation. With the latest kernel I was able to boot into LightDM and log into XFCE. Unfortunately, after rebooting, XFCE was flashing at my native resolution of 3840x2160. Reducing the resolution to 2560x1440 stopped the flashing.</p><p>With SDDM + KDE Plasma and GDM + GNOME, I wasn&rsquo;t even able to see the display manager and was greeted with a white screen and my cursor.</p><p>That means the latest kernel fixes only half the problem. After I tried a quick installation of Arch and experienced the exact same issues, I did some research and stumbled upon this issue on the GitLab instance of freedesktop.org: <a target=_blank rel="noopener noreferrer" href=https://gitlab.freedesktop.org/drm/amd/-/issues/2354 aria-label="Flickering or constant solid white screen with kernel >=6.1.4" title="Flickering or constant solid white screen with kernel >=6.1.4">Flickering or constant solid white screen with kernel >=6.1.4</a></p><p>In the comments, <a target=_blank rel="noopener noreferrer" href=https://gitlab.freedesktop.org/drm/amd/-/issues/2354#note_1765479 aria-label="Flickering or constant solid white screen with kernel >=6.1.4" title="Flickering or constant solid white screen with kernel >=6.1.4">user yswtrue suggested</a> to use the kernel parameter <code>amdgpu.sg_display=0</code>. Searching for this parameter I found <a target=_blank rel="noopener noreferrer" href=https://www.phoronix.com/news/AMD-Scatter-Gather-Re-Enabled aria-label="AMD Re-Enables Scatter/Gather Support For All APUs On Linux" title="AMD Re-Enables Scatter/Gather Support For All APUs On Linux">this post on Phoronix</a>, which references said GitLab issue and gives further background information on the problem.</p><p>So, adding <code>boot.kernelParams = ["amdgpu.sg_display=0"]</code> to <code>configuration.nix</code> also fixed the problem with a flashing screen in XFCE and the white screen in SDDM + KDE Plasma and GDM + Gnome.</p><p>As stated in the Phoronix article, AMD introduced the relevant changes in kernel version 6.2.<br>Therefore, kernel version 6.1 would be another solution without the need for a kernel parameter:</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#c1abea>boot</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>kernelPackages</span> = <span style=color:#c1abea>pkgs</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>linuxPackages_6_1</span>;
</span></span></code></pre></div><p>Yes, the GitLab issue speaks of kernel versions 6.1.4 or higher to be affected, but I tested it with 6.1.16 (that&rsquo;s what NixOS installs automatically with the line above) and it worked for me.</p><p>I also tested the mainline kernel version 6.3-rc1 and unfortunately this version still needed the additional kernel parameter.</p><p>Personally I&rsquo;ll use the latest kernel, since there should be more changes and improvements in kernel 6.2 regarding AMD Raphael.</p><p>I&rsquo;m really looking forward to using NixOS. I love the idea of the declarative approach, which already made this whole troubleshooting and experimenting process so much more comfortable for me.</p><h2 id=installation-guide><a href=#installation-guide>Installation guide</a></h2><ol><li>Pick the second option with <code>nomodeset</code> to get the installer up and running</li><li>Follow the installation process and reboot at the end</li><li>After the reboot you&rsquo;ll be booted straight into tty</li><li>Login with your user</li><li>Open the configuration file, e.g.</li></ol><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo nano ../../etc/nixos/configuration.nix
</span></span></code></pre></div><ol start=6><li>Add one of the following solutions to your configuration:</li></ol><ul><li>If you want to go with the latest kernel:</li></ul><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#c1abea>boot</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>kernelPackages</span> = <span style=color:#c1abea>pkgs</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>linuxPackages_latest</span>;
</span></span><span style=display:flex><span><span style=color:#c1abea>boot</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>kernelParams</span> = [<span style=color:#63c381>&#34;amdgpu.sg_display=0&#34;</span>];
</span></span></code></pre></div><ul><li>If you want to stick with kernel 6.1:</li></ul><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#c1abea>boot</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>kernelPackages</span> = <span style=color:#c1abea>pkgs</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>linuxPackages_6_1</span>;
</span></span></code></pre></div><ol start=7><li>Rebuild with</li></ol><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo nixos-rebuild switch
</span></span></code></pre></div><ol start=8><li>Reboot after the rebuild is finished</li></ol><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>reboot
</span></span></code></pre></div><ol start=9><li>Pick the newest generation</li><li>Now you should be able to boot into your display manager and log into your desktop environment</li></ol></div></article></main><footer><span>&copy;
2022&nbsp;&ndash;
2023
stffffn</span><div><span>Content is
<a target=_blank rel="noopener noreferrer" aria-label="Creative Commens CC BY-SA 4.0" title="Creative Commens CC BY-SA 4.0" href=https://creativecommons.org/licenses/by-sa/4.0/>CC-BY-SA 4.0</a>,</span>
<span><a target=_blank rel="noopener noreferrer" aria-label="Source code" title="Source code" href=https://github.com/stffffn/hugo-blog>Source code</a>
is
<a target=_blank rel="noopener noreferrer" aria-label="GNU General Public License 3.0" title="GNU General Public License 3.0" href=https://www.gnu.org/licenses/gpl-3.0.en.html>GPL 3.0</a></span></div></footer></body></html>