<!doctype html><html lang=en-US><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="IE=edge"><link rel=alternate type=application/rss+xml title="RSS Feed for blabli.blog" href=https://blabli.blog/index.xml><meta property="og:title" content="NixOS + AMD Raphael iGPU: Fix for white/flashing Screens and a Guide for Graphical Installation / Bla Bli Blog"><meta property="og:description" content="
    
      How to fix white or flashing screens in NixOS when using the iGPU of an AMD Ryzen 7000 series CPU (Raphael).
    
  "><meta property="og:type" content="
    article
  "><meta property="og:url" content="https://blabli.blog/post/2023/03/14/nixos-amd-raphael-igpu-screen-issues/"><meta property="og:image" content="https://blabli.blog/images/nixos-amd/nixos-amd-feature-image.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-03-14T00:00:00+00:00"><meta property="article:modified_time" content="2023-03-14T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blabli.blog/images/nixos-amd/nixos-amd-feature-image.png"><meta name=twitter:title content="NixOS + AMD Raphael iGPU: Fix for white/flashing Screens and a Guide for Graphical Installation / Bla Bli Blog"><meta name=twitter:description content="
    
      How to fix white or flashing screens in NixOS when using the iGPU of an AMD Ryzen 7000 series CPU (Raphael).
    
  "><title>NixOS + AMD Raphael iGPU: Fix for white/flashing Screens and a Guide for Graphical Installation / Bla Bli Blog</title>
<meta name=author content="stffffn"><meta name=description content="
        
          How to fix white or flashing screens in NixOS when using the iGPU of an AMD Ryzen 7000 series CPU (Raphael).
        

      
      "><link key=canonical rel=canonical href=https://blabli.blog/post/2023/03/14/nixos-amd-raphael-igpu-screen-issues/><link rel=icon type=image/png sizes=32x32 href=https://blabli.blog/favicons/favicon-32.png><link rel=icon type=image/png sizes=128x128 href=https://blabli.blog/favicons/favicon-128.png><link rel=icon type=image/png sizes=192x192 href=https://blabli.blog/favicons/favicon-192.png><link rel=apple-touch-icon type=image/png sizes=152x152 href=https://blabli.blog/favicons/favicon-152.png><link rel=apple-touch-icon type=image/png sizes=167x167 href=https://blabli.blog/favicons/favicon-167.png><link rel=apple-touch-icon type=image/png sizes=180x180 href=https://blabli.blog/favicons/favicon-180.png><link rel="shortcut icon" type=image/png sizes=196x196 href=https://blabli.blog/favicons/favicon-196.png><style>html{visibility:hidden}</style><link rel=stylesheet href=https://blabli.blog/scss/styles.css></head><body><header><a aria-label=Home title="Bla Bli Blog" href=https://blabli.blog>Bla Bli Blog</a><nav><a class=menu-item aria-label=Tags title=Tags href=https://blabli.blog/tags><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M181.3 32.4c17.4 2.9 29.2 19.4 26.3 36.8L197.8 128h95.1l11.5-69.3c2.9-17.4 19.4-29.2 36.8-26.3s29.2 19.4 26.3 36.8L357.8 128H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H347.1L325.8 320H384c17.7.0 32 14.3 32 32s-14.3 32-32 32H315.1l-11.5 69.3c-2.9 17.4-19.4 29.2-36.8 26.3s-29.2-19.4-26.3-36.8l9.8-58.7H155.1l-11.5 69.3c-2.9 17.4-19.4 29.2-36.8 26.3s-29.2-19.4-26.3-36.8L90.2 384H32c-17.7.0-32-14.3-32-32s14.3-32 32-32h68.9l21.3-128H64c-17.7.0-32-14.3-32-32s14.3-32 32-32h68.9l11.5-69.3c2.9-17.4 19.4-29.2 36.8-26.3zM187.1 192 165.8 320h95.1l21.3-128H187.1z"/></svg></a><a class=menu-item aria-label="Mate Rating" title="Mate Rating" href=https://blabli.blog/mate-rating><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path d="M96 0C82.7.0 72 10.7 72 24s10.7 24 24 24c4.4.0 8 3.6 8 8v64.9c0 12.2-7.2 23.1-17.2 30.1C53.7 174.1 32 212.5 32 256V448c0 35.3 28.7 64 64 64H224c35.3.0 64-28.7 64-64V256c0-43.5-21.7-81.9-54.8-105-10-7-17.2-17.9-17.2-30.1V56c0-4.4 3.6-8 8-8 13.3.0 24-10.7 24-24S237.3.0 224 0h-8H104 96zm64 382c-26.5.0-48-20.1-48-45 0-16.8 22.1-48.1 36.3-66.4 6-7.8 17.5-7.8 23.5.0C185.9 288.9 208 320.2 208 337c0 24.9-21.5 45-48 45z"/></svg></a><a class=menu-item aria-label=RSS title=RSS href=https://blabli.blog/index.xml><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M64 32C28.7 32 0 60.7.0 96V416c0 35.3 28.7 64 64 64H384c35.3.0 64-28.7 64-64V96c0-35.3-28.7-64-64-64H64zM96 136c0-13.3 10.7-24 24-24 137 0 248 111 248 248 0 13.3-10.7 24-24 24s-24-10.7-24-24c0-110.5-89.5-2e2-2e2-2e2-13.3.0-24-10.7-24-24zm0 96c0-13.3 10.7-24 24-24 83.9.0 152 68.1 152 152 0 13.3-10.7 24-24 24s-24-10.7-24-24c0-57.4-46.6-104-104-104-13.3.0-24-10.7-24-24zm0 120a32 32 0 1164 0 32 32 0 11-64 0z"/></svg></a><a class=menu-item target=_blank rel="noopener noreferrer" aria-label=GitHub title=GitHub href=https://github.com/stffffn><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></a><a class=menu-item target=_blank rel="noopener noreferrerme" aria-label=Mastodon title=Mastodon href=https://mastodon.social/@stffffn><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48.0.0.0-63.72 28.5-63.72 125.7.0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54.0 01-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg></a></nav></header><main><article><div class=post-info><h2>NixOS + AMD Raphael iGPU: Fix for white/flashing Screens and a Guide for Graphical Installation</h2><div class=post-data><time datetime=2023-03-14>March 14, 2023</time><div class=post-tags><a aria-label=#amd title=#amd href=https://blabli.blog/tags/amd>#amd</a>
<a aria-label=#linux title=#linux href=https://blabli.blog/tags/linux>#linux</a>
<a aria-label=#nixos title=#nixos href=https://blabli.blog/tags/nixos>#nixos</a></div></div></div><div class=post-content><div class="alert alert-update"><h3><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M256 512A256 256 0 10256 0a256 256 0 100 512zM216 336h24V272H216c-13.3.0-24-10.7-24-24s10.7-24 24-24h48c13.3.0 24 10.7 24 24v88h8c13.3.0 24 10.7 24 24s-10.7 24-24 24H216c-13.3.0-24-10.7-24-24s10.7-24 24-24zm40-208a32 32 0 110 64 32 32 0 110-64z"/></svg>Update</h3><p>The fix is now also available as a module in <a target=_blank rel="noopener noreferrer" href=https://github.com/NixOS/nixos-hardware/blob/master/common/cpu/amd/raphael/igpu.nix>nixos-hardware</a></p></div><p>This post has a tl;dr section just for the necessary changes to get the integrated GPU (iGPU) working and fix the screen issues, a short write-up of my experience, with some additional links for further information and at the end you&rsquo;ll find a condensed guide for the graphical installation process.</p><h2 id=tldr><a href=#tldr>tl;dr</a></h2><p>To be able to use the integrated graphics of your Ryzen 7000-series CPU you can either&mldr;</p><ul><li>use the 6.1 kernel:</li></ul><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#c1abea>boot</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>kernelPackages</span> = <span style=color:#c1abea>pkgs</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>linuxPackages_6_1</span>;
</span></span></code></pre></div><ul><li>or use the latest kernel, which also needs an additional kernel parameter to fix the white or flashing screen issues:</li></ul><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#c1abea>boot</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>kernelPackages</span> = <span style=color:#c1abea>pkgs</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>linuxPackages_latest</span>;
</span></span><span style=display:flex><span><span style=color:#c1abea>boot</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>kernelParams</span> = [<span style=color:#63c381>&#34;amdgpu.sg_display=0&#34;</span>];
</span></span></code></pre></div><p>Well, at least both solutions worked for me.<br>Tested with LightDM + XFCE, SDDM + KDE Plasma, GDM + GNOME.</p><h2 id=my-experience><a href=#my-experience>My experience</a></h2><p>A week ago I built a new desktop PC including an AMD Ryzen 7950x. For the time being I use its iGPU to run my 32" 4k monitor (LG 32BN67U-B) via HDMI.</p><p>At the time of writing this post, the current NixOS version is 22.11, which comes with the 5.15 Linux kernel. Support for the iGPU of the new AMD Ryzen 7000 series CPUs (Raphael) comes with a later version of the kernel (5.18). Therefore, the issues aren&rsquo;t specific to NixOS, but affect any Linux distribution that comes with a kernel that is too old.</p><p>To use the latest kernel (6.2) in NixOS I added <code>boot.kernelPackages = pkgs.linuxPackages_latest</code> to the <code>configuration.nix</code> file.</p><p>Without any changes I booted straight to tty after the installation. With the latest kernel I was able to boot into LightDM and log into XFCE. Unfortunately, after rebooting, XFCE was flashing at my native resolution of 3840x2160. Reducing the resolution to 2560x1440 stopped the flashing.</p><p>With SDDM + KDE Plasma and GDM + GNOME, I wasn&rsquo;t even able to see the display manager and was greeted with a white screen and my cursor.</p><p>That means the latest kernel fixes only half the problem. After I tried a quick installation of Arch and experienced the exact same issues, I did some research and stumbled upon this issue on the GitLab instance of freedesktop.org: <a target=_blank rel="noopener noreferrer" href=https://gitlab.freedesktop.org/drm/amd/-/issues/2354 aria-label="Flickering or constant solid white screen with kernel >=6.1.4" title="Flickering or constant solid white screen with kernel >=6.1.4">Flickering or constant solid white screen with kernel >=6.1.4</a></p><p>In the comments, <a target=_blank rel="noopener noreferrer" href=https://gitlab.freedesktop.org/drm/amd/-/issues/2354#note_1765479 aria-label="Flickering or constant solid white screen with kernel >=6.1.4" title="Flickering or constant solid white screen with kernel >=6.1.4">user yswtrue suggested</a> to use the kernel parameter <code>amdgpu.sg_display=0</code>. Searching for this parameter I found <a target=_blank rel="noopener noreferrer" href=https://www.phoronix.com/news/AMD-Scatter-Gather-Re-Enabled aria-label="AMD Re-Enables Scatter/Gather Support For All APUs On Linux" title="AMD Re-Enables Scatter/Gather Support For All APUs On Linux">this post on Phoronix</a>, which references said GitLab issue and gives further background information on the problem.</p><p>So, adding <code>boot.kernelParams = ["amdgpu.sg_display=0"]</code> to <code>configuration.nix</code> also fixed the problem with a flashing screen in XFCE and the white screen in SDDM + KDE Plasma and GDM + Gnome.</p><p>As stated in the Phoronix article, AMD introduced the relevant changes in kernel version 6.2.<br>Therefore, kernel version 6.1 would be another solution without the need for a kernel parameter:</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#c1abea>boot</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>kernelPackages</span> = <span style=color:#c1abea>pkgs</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>linuxPackages_6_1</span>;
</span></span></code></pre></div><p>Yes, the GitLab issue speaks of kernel versions 6.1.4 or higher to be affected, but I tested it with 6.1.16 (that&rsquo;s what NixOS installs automatically with the line above) and it worked for me.</p><p>I also tested the mainline kernel version 6.3-rc1 and unfortunately this version still needed the additional kernel parameter.</p><p>Personally I&rsquo;ll use the latest kernel, since there should be more changes and improvements in kernel 6.2 regarding AMD Raphael.</p><p>I&rsquo;m really looking forward to using NixOS. I love the idea of the declarative approach, which already made this whole troubleshooting and experimenting process so much more comfortable for me.</p><h2 id=installation-guide><a href=#installation-guide>Installation guide</a></h2><ol><li>Pick the second option with <code>nomodeset</code> to get the installer up and running</li><li>Follow the installation process and reboot at the end</li><li>After the reboot you&rsquo;ll be booted straight into tty</li><li>Login with your user</li><li>Open the configuration file, e.g.</li></ol><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo nano ../../etc/nixos/configuration.nix
</span></span></code></pre></div><ol start=6><li>Add one of the following solutions to your configuration:</li></ol><ul><li>If you want to go with the latest kernel:</li></ul><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#c1abea>boot</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>kernelPackages</span> = <span style=color:#c1abea>pkgs</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>linuxPackages_latest</span>;
</span></span><span style=display:flex><span><span style=color:#c1abea>boot</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>kernelParams</span> = [<span style=color:#63c381>&#34;amdgpu.sg_display=0&#34;</span>];
</span></span></code></pre></div><ul><li>If you want to stick with kernel 6.1:</li></ul><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#c1abea>boot</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>kernelPackages</span> = <span style=color:#c1abea>pkgs</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>linuxPackages_6_1</span>;
</span></span></code></pre></div><ol start=7><li>Rebuild with</li></ol><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo nixos-rebuild switch
</span></span></code></pre></div><ol start=8><li>Reboot after the rebuild is finished</li></ol><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>reboot
</span></span></code></pre></div><ol start=9><li>Pick the newest generation</li><li>Now you should be able to boot into your display manager and log into your desktop environment</li></ol></div></article></main><footer><span>&copy;
2022&nbsp;&ndash;
2023
stffffn</span><div><span>Content is
<a target=_blank rel="noopener noreferrer" aria-label="Creative Commens CC BY-SA 4.0" title="Creative Commens CC BY-SA 4.0" href=https://creativecommons.org/licenses/by-sa/4.0/>CC-BY-SA 4.0</a>,
</span><span><a target=_blank rel="noopener noreferrer" aria-label="Source code on GitHub" title="Source code on GitHub" href=https://github.com/stffffn/hugo-blog>Source code</a>
is
<a target=_blank rel="noopener noreferrer" aria-label="GNU General Public License 3.0" title="GNU General Public License 3.0" href=https://www.gnu.org/licenses/gpl-3.0.en.html>GPL 3.0</a></span></div></footer></body></html>